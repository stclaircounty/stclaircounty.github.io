{{ define "main" }}
{{/* Pull incidents from data file */}}
{{ $incidentsData := site.Data.incidents }}
{{ $incidents := slice }}
{{ range $key, $incident := $incidentsData }}
  {{ if not (hasPrefix $key "_") }}
    {{ $incidents = $incidents | append (merge $incident (dict "key" $key)) }}
  {{ end }}
{{ end }}
{{ $incidents = sort $incidents "date" "desc" }}

{{/* Count by severity */}}
{{ $critical := 0 }}
{{ $high := 0 }}
{{ $medium := 0 }}
{{ $low := 0 }}
{{ range $incidents }}
  {{ if eq .severity "critical" }}{{ $critical = add $critical 1 }}
  {{ else if eq .severity "high" }}{{ $high = add $high 1 }}
  {{ else if eq .severity "medium" }}{{ $medium = add $medium 1 }}
  {{ else }}{{ $low = add $low 1 }}{{ end }}
{{ end }}

{{ partial "list-header.html" (dict
  "page" .
  "icon" "warning"
  "title" "Incident Reports"
  "description" "Documented incidents involving St. Clair County Sheriff's Department personnel, compiled from official records, news reports, and legal filings."
  "count" (len $incidents)
  "count_label" "Incidents"
  "stats" (slice
    (dict "value" (add $critical $high) "label" "High/Critical")
  )
) }}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  {{ with .Content }}
  <div class="prose prose-lg max-w-none mb-8">
    {{ . }}
  </div>
  {{ end }}

  {{ if $incidents }}

  {{/* Stats bar */}}
  {{ partial "case-file/stats-bar.html" (dict "stats" (slice
    (dict "value" $critical "label" "Critical" "color" "red")
    (dict "value" $high "label" "High" "color" "orange")
    (dict "value" $medium "label" "Medium" "color" "yellow")
    (dict "value" $low "label" "Low" "color" "gray")
  )) }}

  {{/* Incidents List */}}
  <div class="space-y-6">
    {{ range $incidents }}
    {{ partial "incident/card.html" (dict "key" .key "data" .) }}
    {{ end }}
  </div>

  {{ else }}
  <div class="text-center py-16">
    <svg class="h-16 w-16 text-gray-300 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    </svg>
    <p class="text-slate-light text-lg">No incidents documented yet.</p>
  </div>
  {{ end }}
</div>
{{ end }}
