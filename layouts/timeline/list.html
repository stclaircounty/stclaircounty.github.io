{{ define "main" }}
{{ $timelineData := site.Data.timeline }}
{{ $people := site.Data.people }}

{{/* Build sorted events list from data */}}
{{ $events := slice }}
{{ range $key, $event := $timelineData }}
  {{ if not (hasPrefix $key "_") }}
    {{ $events = $events | append (merge $event (dict "key" $key)) }}
  {{ end }}
{{ end }}
{{ $events = sort $events "date" "desc" }}

{{ partial "list-header.html" (dict
  "page" .
  "icon" "calendar"
  "title" "Timeline of Events"
  "description" "A chronological record of documented incidents, actions, and legal proceedings."
  "count" (len $events)
  "count_label" "Events"
) }}

<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  {{ with .Content }}
  <div class="prose prose-lg max-w-none mb-8">
    {{ . }}
  </div>
  {{ end }}

  {{ if $events }}

  <!-- Filter Controls -->
  <div class="bg-white rounded-lg shadow-card p-4 mb-8 sticky top-20 z-10">
    <div class="flex flex-wrap gap-4 items-center">
      <span class="text-sm font-medium text-slate">Filter:</span>
      <div class="flex flex-wrap gap-2">
        <button class="badge badge-severity-critical hover:opacity-80 cursor-pointer transition-opacity" data-filter="critical">Critical</button>
        <button class="badge badge-severity-high hover:opacity-80 cursor-pointer transition-opacity" data-filter="high">High</button>
        <button class="badge badge-severity-medium hover:opacity-80 cursor-pointer transition-opacity" data-filter="medium">Medium</button>
        <button class="badge bg-blue-100 text-blue-800 hover:opacity-80 cursor-pointer transition-opacity" data-filter="litigation">Litigation</button>
        <button class="badge bg-gray-100 text-slate hover:bg-gray-200 cursor-pointer transition-opacity" data-filter="all">All</button>
      </div>
    </div>
  </div>

  <!-- Timeline -->
  <div class="relative">
    <!-- Timeline line -->
    <div class="absolute left-6 top-0 bottom-0 w-0.5 bg-gradient-to-b from-navy via-accent to-navy-light"></div>

    <div class="space-y-8">
      {{ $currentYear := "" }}
      {{ range $events }}
      {{ $event := . }}

      {{/* Year marker */}}
      {{ $year := (time .date).Format "2006" }}
      {{ if ne $year $currentYear }}
      {{ $currentYear = $year }}
      <div class="relative flex items-center">
        <div class="absolute left-4 w-5 h-5 rounded-full bg-navy border-4 border-white shadow"></div>
        <div class="ml-16 px-4 py-2 bg-navy text-white rounded-lg font-bold text-lg">
          {{ $year }}
        </div>
      </div>
      {{ end }}

      {{/* Event card */}}
      {{ $severity := .severity | default "medium" }}
      {{ $isLitigation := eq .event_type "litigation" }}
      <div class="relative pl-16 timeline-event" data-severity="{{ $severity }}" data-type="{{ .event_type }}">
        <!-- Timeline dot -->
        <div class="absolute left-4 w-5 h-5 rounded-full border-4 border-white shadow
          {{ if eq $severity "critical" }}bg-red-500
          {{ else if eq $severity "high" }}bg-orange-500
          {{ else if eq $severity "medium" }}bg-yellow-500
          {{ else if $isLitigation }}bg-blue-500
          {{ else }}bg-gray-400{{ end }}">
        </div>

        <div class="card">
          <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2 flex-wrap">
                <span class="text-sm font-medium text-slate-light">
                  {{ (time .date).Format "January 2, 2006" }}
                </span>
                {{ with .severity }}
                <span class="badge badge-severity-{{ . }}">{{ . | title }}</span>
                {{ end }}
                {{ with .event_type }}
                <span class="badge {{ if eq . "litigation" }}bg-blue-100 text-blue-800{{ else }}bg-gray-100 text-slate{{ end }}">{{ . | humanize }}</span>
                {{ end }}
                {{ with .incident_type }}
                <span class="badge bg-gray-100 text-slate">{{ . | humanize }}</span>
                {{ end }}
              </div>

              <h3 class="text-xl font-bold text-navy mb-2" style="margin-top: 0;">
                {{ .title }}
              </h3>

              {{ with .location }}
              <p class="text-sm text-slate-light mb-2 flex items-center">
                <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                {{ . }}
              </p>
              {{ end }}

              {{ with .summary }}
              <p class="text-slate mb-3">{{ . | markdownify }}</p>
              {{ end }}

              {{/* Details list */}}
              {{ with .details }}
              <ul class="text-sm text-slate space-y-1 mb-3">
                {{ range . }}
                <li class="flex items-start gap-2">
                  <span class="text-slate-light mt-1">•</span>
                  {{ . }}
                </li>
                {{ end }}
              </ul>
              {{ end }}

              {{/* Holdings for court rulings */}}
              {{ with .holdings }}
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                <p class="text-xs font-semibold text-blue-800 uppercase tracking-wide mb-2">Court Holdings</p>
                <ul class="text-sm text-blue-900 space-y-1">
                  {{ range . }}
                  <li class="flex items-start gap-2">
                    <span class="text-blue-500 mt-1">✓</span>
                    {{ . }}
                  </li>
                  {{ end }}
                </ul>
              </div>
              {{ end }}

              {{/* People involved */}}
              {{ with .people_involved }}
              <div class="flex flex-wrap gap-1 mt-3">
                {{ range $personKey, $involvement := . }}
                {{ $person := index $people $personKey }}
                {{ $hasPage := site.GetPage (printf "/people/%s" $personKey) }}
                {{ if $hasPage }}
                <a href="/people/{{ $personKey }}/" class="text-xs px-2 py-0.5 bg-gold/10 text-gold hover:bg-gold/20 rounded transition-colors">
                  {{ if $person }}{{ $person.name }}{{ else }}{{ $personKey | humanize }}{{ end }}
                  {{ with $involvement.role }}<span class="text-gold/70">({{ . }})</span>{{ end }}
                </a>
                {{ else }}
                <span class="text-xs px-2 py-0.5 bg-gray-100 text-slate rounded">
                  {{ if $person }}{{ $person.name }}{{ else }}{{ $personKey | humanize }}{{ end }}
                  {{ with $involvement.role }}<span class="text-slate-light">({{ . }})</span>{{ end }}
                </span>
                {{ end }}
                {{ end }}
              </div>
              {{ end }}
            </div>

            {{/* Significance sidebar */}}
            {{ with .significance }}
            <div class="flex-shrink-0 sm:max-w-xs">
              <span class="text-xs uppercase tracking-wide text-slate-light">Significance</span>
              <p class="text-sm text-slate mt-1">{{ . | markdownify }}</p>
            </div>
            {{ end }}
          </div>

          {{/* Failure point callout */}}
          {{ with .failure_point }}
          <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="grid sm:grid-cols-2 gap-4">
              {{ with .should_have }}
              <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                <p class="text-xs font-semibold text-green-800 uppercase tracking-wide mb-2">What Should Have Happened</p>
                <ul class="text-sm text-green-900 space-y-1">
                  {{ range . }}
                  <li class="flex items-start gap-2">
                    <span class="text-green-500 mt-1">✓</span>
                    {{ . }}
                  </li>
                  {{ end }}
                </ul>
              </div>
              {{ end }}
              {{ with .actually_happened }}
              <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                <p class="text-xs font-semibold text-red-800 uppercase tracking-wide mb-2">What Actually Happened</p>
                <ul class="text-sm text-red-900 space-y-1">
                  {{ range . }}
                  <li class="flex items-start gap-2">
                    <span class="text-red-500 mt-1">✗</span>
                    {{ . }}
                  </li>
                  {{ end }}
                </ul>
              </div>
              {{ end }}
            </div>
          </div>
          {{ end }}

          {{/* Related incident */}}
          {{ with .related_incident }}
          {{ $incident := index site.Data.incidents . }}
          {{ if $incident }}
          {{ $incidentHasPage := site.GetPage (printf "/incidents/%s" .) }}
          <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex items-center gap-2 text-sm">
              {{ partial "header-icon.html" (dict "icon" "warning" "class" "w-4 h-4 text-red-500") }}
              <span class="text-slate-light">Related Incident:</span>
              {{ if $incidentHasPage }}
              <a href="/incidents/{{ . }}/" class="font-medium text-accent hover:underline">{{ $incident.title }}</a>
              {{ else }}
              <span class="font-medium text-navy">{{ $incident.title }}</span>
              {{ end }}
            </div>
          </div>
          {{ end }}
          {{ end }}

          {{/* Related litigation */}}
          {{ with .related_litigation }}
          {{ $litigation := index site.Data.litigation . }}
          {{ if $litigation }}
          <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex items-center gap-2 text-sm">
              {{ partial "header-icon.html" (dict "icon" "scale" "class" "w-4 h-4 text-blue-500") }}
              <span class="text-slate-light">Related Case:</span>
              <a href="/litigation/{{ . }}/" class="font-medium text-blue-600 hover:underline">{{ $litigation.short_title }}</a>
              <span class="text-slate-light">({{ $litigation.case_number }})</span>
            </div>
          </div>
          {{ end }}
          {{ end }}

          {{/* Sources */}}
          {{ with .sources }}
          <div class="mt-4 pt-4 border-t border-gray-200">
            <span class="text-xs uppercase tracking-wide text-slate-light">Sources:</span>
            <div class="flex flex-wrap gap-2 mt-1">
              {{ range . }}
              {{ if eq .type "deposition" }}
              {{ $depoHasPage := site.GetPage (printf "/depositions/%s" .ref) }}
              {{ if $depoHasPage }}
              <a href="/depositions/{{ .ref }}/" class="text-sm text-accent hover:underline">
                Deposition: {{ .ref | humanize }}
              </a>
              {{ else }}
              <span class="text-sm text-slate">Deposition: {{ .ref | humanize }}</span>
              {{ end }}
              {{ else if eq .type "news" }}
              <a href="{{ .url }}" target="_blank" rel="noopener" class="text-sm text-accent hover:underline">
                {{ .title }}
              </a>
              {{ else }}
              <span class="text-sm text-slate">{{ .type | humanize }}</span>
              {{ end }}
              {{ end }}
            </div>
          </div>
          {{ end }}

          {{/* Tags */}}
          {{ with .tags }}
          <div class="mt-3 flex flex-wrap gap-1">
            {{ range . }}
            <span class="text-xs px-2 py-0.5 bg-gray-100 text-slate-light rounded">{{ . }}</span>
            {{ end }}
          </div>
          {{ end }}
        </div>
      </div>
      {{ end }}
    </div>
  </div>

  {{ else }}
  <div class="text-center py-16">
    <svg class="h-16 w-16 text-gray-300 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <p class="text-slate-light text-lg">No timeline events documented yet.</p>
  </div>
  {{ end }}
</div>

{{ end }}

{{ define "scripts" }}
<script>
// Filter functionality
document.querySelectorAll('[data-filter]').forEach(btn => {
  btn.addEventListener('click', function() {
    const filter = this.dataset.filter;
    document.querySelectorAll('.timeline-event').forEach(event => {
      if (filter === 'all') {
        event.style.display = 'block';
      } else if (filter === 'litigation') {
        event.style.display = event.dataset.type === 'litigation' ? 'block' : 'none';
      } else {
        event.style.display = event.dataset.severity === filter ? 'block' : 'none';
      }
    });

    // Update active state
    document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('ring-2', 'ring-offset-1'));
    this.classList.add('ring-2', 'ring-offset-1');
  });
});
</script>
{{ end }}
