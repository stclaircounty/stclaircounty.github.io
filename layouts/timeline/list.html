{{ define "main" }}
{{/* Get timeline pages sorted by date descending */}}
{{ $events := where .Pages "Kind" "page" }}
{{ $events = sort $events "Date" "desc" }}

{{/* Collect unique incidents and people for filter dropdowns */}}
{{ $incidents := slice }}
{{ $people := slice }}
{{ range $events }}
  {{ with .Params.incident }}
    {{ if not (in $incidents .) }}
      {{ $incidents = $incidents | append . }}
    {{ end }}
  {{ end }}
  {{ range .Params.officers_involved }}
    {{ if not (in $people .) }}
      {{ $people = $people | append . }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $incidents = sort $incidents }}
{{ $people = sort $people }}

{{/* Page Header */}}
{{ partial "list-header.html" (dict
  "page" .
  "icon" "calendar"
  "title" "Timeline of Events"
  "description" "A chronological record of documented incidents. Click any event to learn more."
  "count" (len $events)
  "count_label" "Events"
) }}

<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  {{ with .Content }}
  <div class="prose prose-sm sm:prose-lg max-w-none mb-8">
    {{ . }}
  </div>
  {{ end }}

  {{ if $events }}

  <!-- Filter Controls -->
  <div class="bg-gradient-to-r from-slate-50 to-white rounded-xl shadow-md border border-gray-200 p-6 mb-8">
    <div class="flex flex-wrap items-center gap-4">
      <div class="flex items-center gap-2 text-navy">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
        <span class="text-sm font-semibold">Filter by:</span>
      </div>

      <!-- Incident Filter -->
      <div class="flex-1 min-w-[200px] relative">
        <label for="incident-filter" class="sr-only">Filter by incident</label>
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <select id="incident-filter" class="w-full pl-10 pr-10 py-2.5 text-sm font-medium text-navy bg-white border-2 border-slate-200 rounded-lg shadow-sm appearance-none cursor-pointer hover:border-accent focus:border-accent focus:ring-2 focus:ring-accent/20 focus:outline-none transition-all duration-200">
          <option value="">All Incidents</option>
          {{ range $incidents }}
          <option value="{{ . }}">{{ . | humanize | title }}</option>
          {{ end }}
        </select>
        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
          <svg class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </div>

      <!-- Person Filter -->
      <div class="flex-1 min-w-[200px] relative">
        <label for="person-filter" class="sr-only">Filter by person</label>
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        <select id="person-filter" class="w-full pl-10 pr-10 py-2.5 text-sm font-medium text-navy bg-white border-2 border-slate-200 rounded-lg shadow-sm appearance-none cursor-pointer hover:border-accent focus:border-accent focus:ring-2 focus:ring-accent/20 focus:outline-none transition-all duration-200">
          <option value="">All People</option>
          {{ range $people }}
          <option value="{{ . }}">{{ . | humanize | title }}</option>
          {{ end }}
        </select>
        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
          <svg class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </div>

      <!-- Reset Button -->
      <button id="reset-filters" class="inline-flex items-center gap-2 px-4 py-2.5 text-sm font-semibold text-slate-600 hover:text-white bg-slate-100 hover:bg-navy border-2 border-slate-200 hover:border-navy rounded-lg transition-all duration-200 shadow-sm">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Reset
      </button>
    </div>

    <!-- Active filters count -->
    <div id="filter-status" class="mt-4 pt-4 border-t border-slate-200 text-sm text-slate-600 hidden">
      <span class="inline-flex items-center gap-2">
        <span class="flex h-2 w-2 rounded-full bg-accent animate-pulse"></span>
        Showing <span id="visible-count" class="font-bold text-navy">0</span> of <span class="font-bold">{{ len $events }}</span> events
      </span>
    </div>
  </div>

  <!-- Timeline -->
  <div class="relative">
    <!-- Vertical line -->
    <div class="absolute left-4 md:left-8 top-0 bottom-0 w-1 bg-gradient-to-b from-navy via-accent to-navy-light rounded-full"></div>

    <div class="space-y-6">
      {{ $currentYear := "" }}
      {{ range $events }}

      {{/* Year divider */}}
      {{ $year := .Date.Format "2006" }}
      {{ if ne $year $currentYear }}
      {{ $currentYear = $year }}
      <div class="year-divider relative flex items-center py-4" data-year="{{ $year }}">
        <div class="absolute left-2 md:left-6 w-5 h-5 bg-navy rounded-full border-4 border-white shadow-lg z-10"></div>
        <div class="ml-12 md:ml-20">
          <span class="inline-block px-4 py-2 bg-navy text-white font-bold text-xl rounded-lg shadow-lg">
            {{ $year }}
          </span>
        </div>
      </div>
      {{ end }}

      {{/* Event card */}}
      {{ $severity := .Params.severity | default "medium" }}
      {{ $officers := delimit .Params.officers_involved "," }}
      <a href="{{ .Permalink }}"
         class="timeline-event group block relative pl-12 md:pl-20"
         data-incident="{{ .Params.incident }}"
         data-people="{{ $officers }}"
         data-year="{{ $year }}"
         data-severity="{{ $severity }}">
        <!-- Timeline dot -->
        <div class="absolute left-2 md:left-6 w-5 h-5 rounded-full border-4 border-white shadow-lg z-10 transition-transform group-hover:scale-125
          {{ if eq $severity "critical" }}bg-red-500
          {{ else if eq $severity "high" }}bg-orange-500
          {{ else if eq $severity "medium" }}bg-yellow-500
          {{ else }}bg-gray-400{{ end }}">
        </div>

        <!-- Card -->
        <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 transition-all duration-200 group-hover:shadow-xl group-hover:border-accent group-hover:-translate-y-1">
          <!-- Date and badges -->
          <div class="flex flex-wrap items-center gap-3 mb-3">
            <time class="text-sm font-medium text-slate-500">
              {{ .Date.Format "January 2, 2006" }}
              {{ if gt .Date.Hour 0 }}
              <span class="text-slate-400">at {{ .Date.Format "3:04 PM" }}</span>
              {{ end }}
            </time>
            {{ with .Params.severity }}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
              {{ if eq . "critical" }}bg-red-100 text-red-800
              {{ else if eq . "high" }}bg-orange-100 text-orange-800
              {{ else if eq . "medium" }}bg-yellow-100 text-yellow-800
              {{ else }}bg-gray-100 text-gray-800{{ end }}">
              {{ . | title }}
            </span>
            {{ end }}
            {{ with .Params.incident_type }}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
              {{ . | humanize }}
            </span>
            {{ end }}
          </div>

          <!-- Title -->
          <h2 class="text-xl font-bold text-navy mb-2 group-hover:text-accent transition-colors" style="margin: 0 0 0.5rem 0;">
            {{ .Title }}
            <svg class="inline-block w-5 h-5 ml-1 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </h2>

          <!-- Location -->
          {{ with .Params.location }}
          <p class="text-sm text-slate-500 mb-3 flex items-center">
            <svg class="h-4 w-4 mr-1.5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            {{ . }}
          </p>
          {{ end }}

          <!-- Summary -->
          {{ with .Summary }}
          <p class="text-slate-600 mb-4 line-clamp-2">{{ . | plainify | truncate 150 }}</p>
          {{ end }}

          <!-- Officers involved -->
          {{ with .Params.officers_involved }}
          <div class="flex flex-wrap gap-2 mb-3">
            {{ range first 5 . }}
            <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-amber-50 text-amber-700 border border-amber-200">
              {{ . | humanize | title }}
            </span>
            {{ end }}
            {{ if gt (len .) 5 }}
            <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-600">
              +{{ sub (len .) 5 }} more
            </span>
            {{ end }}
          </div>
          {{ end }}

          <!-- Tags -->
          {{ with .Params.tags }}
          <div class="flex flex-wrap gap-1.5">
            {{ range first 3 . }}
            <span class="text-xs text-slate-400">#{{ . }}</span>
            {{ end }}
          </div>
          {{ end }}

          <!-- Click hint -->
          <div class="mt-4 pt-4 border-t border-gray-100 flex items-center justify-between">
            <span class="text-sm text-slate-400 group-hover:text-accent transition-colors">Click to view full details</span>
            <svg class="w-5 h-5 text-slate-300 group-hover:text-accent group-hover:translate-x-1 transition-all" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </div>
        </div>
      </a>
      {{ end }}
    </div>
  </div>

  <!-- Summary -->
  <div class="mt-12 bg-slate-100 rounded-xl p-5 sm:p-8 text-center">
    <p class="text-lg text-slate-600 mb-2">
      <span class="font-bold text-navy text-3xl">{{ len $events }}</span> documented events
    </p>
    <p class="text-slate-500">Click on any event above to see sources, people involved, and full documentation.</p>
  </div>

  {{ else }}
  <div class="text-center py-16">
    <svg class="h-16 w-16 text-gray-300 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <p class="text-slate-500 text-lg">No timeline events documented yet.</p>
  </div>
  {{ end }}
</div>

<!-- Filter JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const incidentFilter = document.getElementById('incident-filter');
  const personFilter = document.getElementById('person-filter');
  const resetBtn = document.getElementById('reset-filters');
  const filterStatus = document.getElementById('filter-status');
  const visibleCount = document.getElementById('visible-count');
  const events = document.querySelectorAll('.timeline-event');
  const yearDividers = document.querySelectorAll('[class*="Year divider"]'); // Will need to mark these

  function filterEvents() {
    const selectedIncident = incidentFilter.value;
    const selectedPerson = personFilter.value;
    let visible = 0;
    const visibleYears = new Set();

    events.forEach(event => {
      const incident = event.dataset.incident || '';
      const people = event.dataset.people || '';
      const year = event.dataset.year || '';

      const matchesIncident = !selectedIncident || incident === selectedIncident;
      const matchesPerson = !selectedPerson || people.split(',').includes(selectedPerson);

      if (matchesIncident && matchesPerson) {
        event.style.display = '';
        visible++;
        visibleYears.add(year);
      } else {
        event.style.display = 'none';
      }
    });

    // Show/hide year dividers based on visible events
    document.querySelectorAll('.year-divider').forEach(divider => {
      const year = divider.dataset.year;
      divider.style.display = visibleYears.has(year) ? '' : 'none';
    });

    // Update status
    if (selectedIncident || selectedPerson) {
      filterStatus.classList.remove('hidden');
      visibleCount.textContent = visible;
    } else {
      filterStatus.classList.add('hidden');
    }
  }

  function resetFilters() {
    incidentFilter.value = '';
    personFilter.value = '';
    filterEvents();
  }

  incidentFilter.addEventListener('change', filterEvents);
  personFilter.addEventListener('change', filterEvents);
  resetBtn.addEventListener('click', resetFilters);
});
</script>
{{ end }}
