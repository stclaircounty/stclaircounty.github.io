{{/*
  Cross-References Partial - Shows where a person/item is mentioned across the site

  Usage: {{ partial "cross-references.html" (dict "type" "person" "key" "mat-king" "page" .) }}

  Parameters:
    - type: person | incident | evidence
    - key: The slug/key of the item
    - page: The current page context
*/}}

{{ $type := .type }}
{{ $key := .key }}
{{ $page := .page }}

{{ $mentions := slice }}

{{ if eq $type "person" }}
  {{/* Find incidents where this person is involved */}}
  {{ range $incidentKey, $incident := site.Data.incidents }}
    {{ if not (hasPrefix $incidentKey "_") }}
      {{ if index $incident.people_involved $key }}
        {{ $mentions = $mentions | append (dict
          "type" "incident"
          "title" $incident.title
          "url" (printf "/incidents/%s/" $incidentKey)
          "role" (index (index $incident.people_involved $key) "role")
          "date" $incident.date
        ) }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* Find depositions where this person is the deponent */}}
  {{ range $depoKey, $depo := site.Data.depositions }}
    {{ if not (hasPrefix $depoKey "_") }}
      {{ if eq $depo.deponent.id $key }}
        {{ $mentions = $mentions | append (dict
          "type" "deposition"
          "title" $depo.title
          "url" (printf "/depositions/%s/" $depoKey)
          "role" "deponent"
          "date" $depo.date
        ) }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* Find litigation where this person is a party */}}
  {{ range $caseKey, $case := site.Data.litigation }}
    {{ if not (hasPrefix $caseKey "_") }}
      {{/* Check plaintiffs */}}
      {{ range $case.parties.plaintiffs }}
        {{ if eq .person $key }}
          {{ $mentions = $mentions | append (dict
            "type" "litigation"
            "title" $case.title
            "url" (printf "/litigation/%s/" $caseKey)
            "role" "plaintiff"
            "date" $case.filed_date
          ) }}
        {{ end }}
      {{ end }}
      {{/* Check defendants */}}
      {{ range $case.parties.defendants }}
        {{ if eq .person $key }}
          {{ $mentions = $mentions | append (dict
            "type" "litigation"
            "title" $case.title
            "url" (printf "/litigation/%s/" $caseKey)
            "role" "defendant"
            "date" $case.filed_date
          ) }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* Find timeline events where this person is involved */}}
  {{ range $eventKey, $event := site.Data.timeline }}
    {{ if not (hasPrefix $eventKey "_") }}
      {{ range $event.people_involved }}
        {{ if eq .person $key }}
          {{ $mentions = $mentions | append (dict
            "type" "timeline"
            "title" $event.title
            "url" (printf "/timeline/%s/" $eventKey)
            "role" .role
            "date" $event.date
          ) }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Render the mentions */}}
{{ if gt (len $mentions) 0 }}
<section class="bg-white rounded-xl border border-slate-200 p-5">
  <h3 class="text-sm font-bold text-navy mb-4 flex items-center gap-2" style="margin-top: 0;">
    <svg class="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
    </svg>
    Also Mentioned In
  </h3>
  <div class="space-y-2">
    {{ range $mentions }}
    {{ $typeIcon := "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" }}
    {{ $typeColor := "text-slate-500" }}
    {{ $typeBg := "bg-slate-100" }}
    {{ if eq .type "incident" }}
      {{ $typeIcon = "M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" }}
      {{ $typeColor = "text-red-500" }}
      {{ $typeBg = "bg-red-50" }}
    {{ else if eq .type "deposition" }}
      {{ $typeIcon = "M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" }}
      {{ $typeColor = "text-amber-500" }}
      {{ $typeBg = "bg-amber-50" }}
    {{ else if eq .type "litigation" }}
      {{ $typeIcon = "M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" }}
      {{ $typeColor = "text-purple-500" }}
      {{ $typeBg = "bg-purple-50" }}
    {{ else if eq .type "timeline" }}
      {{ $typeIcon = "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" }}
      {{ $typeColor = "text-blue-500" }}
      {{ $typeBg = "bg-blue-50" }}
    {{ end }}
    <a href="{{ .url }}" class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50 transition-colors group">
      <div class="p-1.5 rounded {{ $typeBg }} flex-shrink-0">
        <svg class="w-4 h-4 {{ $typeColor }}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="{{ $typeIcon }}" />
        </svg>
      </div>
      <div class="flex-1 min-w-0">
        <p class="text-sm font-medium text-navy group-hover:text-amber-600 transition-colors truncate mb-0">{{ .title }}</p>
        <p class="text-xs text-slate-500 mb-0">{{ .type | title }}{{ with .role }} â€¢ {{ . | humanize }}{{ end }}</p>
      </div>
    </a>
    {{ end }}
  </div>
</section>
{{ end }}
