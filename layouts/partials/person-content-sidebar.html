{{/*
  Person Profile - Sidebar Content (Right Column)

  Contains: Quick Facts, Credibility Assessment, Relationships, Litigation, Tags
*/}}

{{ $person := .person }}
{{ $personKey := .personKey }}
{{ $page := .page }}
{{ $people := site.Data.people }}

{{/* === CREDIBILITY ASSESSMENT (if compromised - show first prominently) === */}}
{{ if or $person.credibility_factors (eq $person.credibility "compromised") }}
<section class="bg-red-50 border-2 border-red-200 rounded-xl p-5">
  <h3 class="text-sm font-bold text-red-800 mb-3 flex items-center gap-2" style="margin-top: 0;">
    <svg class="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    </svg>
    Credibility Assessment
  </h3>

  {{ if eq $person.credibility "compromised" }}
  <div class="bg-red-100 border border-red-300 rounded-lg p-3 mb-3">
    <p class="font-semibold text-red-800 text-sm">Credibility Compromised</p>
    {{ with $person.credibility_note }}
    <p class="text-xs text-red-700 mt-1">{{ . }}</p>
    {{ end }}
  </div>
  {{ else if eq $person.credibility "not-applicable" }}
  <div class="bg-slate-100 border border-slate-200 rounded-lg p-3 mb-3">
    <p class="text-sm text-slate-700">{{ $person.credibility_note | default "Not applicable" }}</p>
  </div>
  {{ end }}

  {{ with $person.credibility_factors }}
  <div class="space-y-2">
    {{ range $key, $value := . }}
    <div class="flex justify-between items-center text-sm">
      <span class="text-red-700">{{ $key | humanize }}</span>
      <span class="font-medium {{ if or (eq $value "Compromised") (eq $value "Severely Compromised") }}text-red-800 bg-red-100 px-2 py-0.5 rounded{{ else }}text-slate-700{{ end }}">{{ $value }}</span>
    </div>
    {{ end }}
  </div>
  {{ end }}
</section>
{{ end }}

{{/* === QUICK FACTS === */}}
{{ $hasEmployment := or $person.employer $person.department $person.division $person.title $person.firm $person.bar_state $person.court $person.start_date $person.end_date $person.side }}
{{ if $hasEmployment }}
<section class="bg-white rounded-xl border border-slate-200 p-5">
  <h3 class="text-sm font-bold text-navy mb-4 flex items-center gap-2" style="margin-top: 0;">
    <svg class="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
    </svg>
    {{ if $person.firm }}Professional Details{{ else if $person.court }}Judicial Position{{ else }}Employment{{ end }}
  </h3>
  <dl class="space-y-3 text-sm">
    {{ with $person.employer }}
    <div>
      <dt class="text-slate-500 text-xs uppercase tracking-wide">Employer</dt>
      <dd class="font-medium text-navy">{{ . }}</dd>
    </div>
    {{ end }}
    {{ with $person.department }}
    <div>
      <dt class="text-slate-500 text-xs uppercase tracking-wide">Department</dt>
      <dd class="font-medium text-navy">{{ . }}</dd>
    </div>
    {{ end }}
    {{ with $person.division }}
    <div>
      <dt class="text-slate-500 text-xs uppercase tracking-wide">Division</dt>
      <dd class="font-medium text-navy">{{ . }}</dd>
    </div>
    {{ end }}
    {{ with $person.title }}
    <div>
      <dt class="text-slate-500 text-xs uppercase tracking-wide">Title</dt>
      <dd class="font-medium text-navy">{{ . }}</dd>
    </div>
    {{ end }}
    {{ with $person.firm }}
    <div>
      <dt class="text-slate-500 text-xs uppercase tracking-wide">Firm</dt>
      <dd class="font-medium text-navy">{{ . }}</dd>
    </div>
    {{ end }}
    {{ with $person.bar_state }}
    <div>
      <dt class="text-slate-500 text-xs uppercase tracking-wide">Bar Admission</dt>
      <dd class="font-medium text-navy">{{ . }}</dd>
    </div>
    {{ end }}
    {{ with $person.court }}
    <div>
      <dt class="text-slate-500 text-xs uppercase tracking-wide">Court</dt>
      <dd class="font-medium text-navy">{{ . }}</dd>
    </div>
    {{ end }}
    {{ with $person.start_date }}
    <div>
      <dt class="text-slate-500 text-xs uppercase tracking-wide">Start Date</dt>
      <dd class="font-medium text-navy">{{ time.Format "January 2006" . }}</dd>
    </div>
    {{ end }}
    {{ with $person.end_date }}
    <div>
      <dt class="text-slate-500 text-xs uppercase tracking-wide">End Date</dt>
      <dd class="font-medium text-navy">{{ time.Format "January 2006" . }}</dd>
    </div>
    {{ end }}
    {{ with $person.side }}
    <div>
      <dt class="text-slate-500 text-xs uppercase tracking-wide">Litigation Side</dt>
      <dd class="font-medium text-navy">{{ . | title }}</dd>
    </div>
    {{ end }}
  </dl>
</section>
{{ end }}

{{/* === RELATIONSHIPS === */}}
{{ with $person.relationships }}
{{ if gt (len .) 0 }}
<section class="bg-white rounded-xl border border-slate-200 p-5">
  <h3 class="text-sm font-bold text-navy mb-4 flex items-center gap-2" style="margin-top: 0;">
    <svg class="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
    </svg>
    Connections
  </h3>
  <div class="space-y-3">
    {{ range $relKey, $rel := . }}
    {{ $relPerson := index $people $relKey }}
    {{ $relHasPage := site.GetPage (printf "/people/%s" $relKey) }}
    {{ $relName := "" }}
    {{ if $relPerson }}{{ $relName = $relPerson.name }}{{ else }}{{ $relName = ($relKey | humanize) }}{{ end }}

    {{/* Generate initials */}}
    {{ $initials := "" }}
    {{ $nameParts := split $relName " " }}
    {{ range $nameParts }}
      {{ $initials = printf "%s%s" $initials (substr . 0 1) }}
    {{ end }}

    {{/* Determine badge color based on relationship type */}}
    {{ $badgeClass := "bg-slate-100 text-slate-700" }}
    {{ $avatarClass := "bg-slate-200 text-slate-600" }}
    {{ if eq $rel.type "family" }}
      {{ $badgeClass = "bg-red-100 text-red-700" }}
      {{ $avatarClass = "bg-red-100 text-red-600" }}
    {{ else if eq $rel.type "social" }}
      {{ $badgeClass = "bg-amber-100 text-amber-700" }}
      {{ $avatarClass = "bg-amber-100 text-amber-600" }}
    {{ else if eq $rel.type "professional" }}
      {{ $badgeClass = "bg-blue-100 text-blue-700" }}
      {{ $avatarClass = "bg-blue-100 text-blue-600" }}
    {{ end }}

    {{ if $relHasPage }}
    <a href="/people/{{ $relKey }}/" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 transition-colors group">
      <div class="w-10 h-10 rounded-full {{ $avatarClass }} flex items-center justify-center text-sm font-semibold flex-shrink-0">
        {{ $initials }}
      </div>
      <div class="flex-1 min-w-0">
        <p class="font-medium text-navy group-hover:text-amber-600 transition-colors truncate mb-0">{{ $relName }}</p>
        <p class="text-xs text-slate-500 truncate mb-0 mt-0.5">{{ $rel.detail }}</p>
      </div>
      <span class="px-2 py-0.5 rounded text-xs font-medium {{ $badgeClass }} flex-shrink-0">{{ $rel.type | title }}</span>
    </a>
    {{ else }}
    <div class="flex items-center gap-3 p-3 rounded-lg bg-slate-50">
      <div class="w-10 h-10 rounded-full {{ $avatarClass }} flex items-center justify-center text-sm font-semibold flex-shrink-0">
        {{ $initials }}
      </div>
      <div class="flex-1 min-w-0">
        <p class="font-medium text-navy truncate mb-0">{{ $relName }}</p>
        <p class="text-xs text-slate-500 truncate mb-0 mt-0.5">{{ $rel.detail }}</p>
      </div>
      <span class="px-2 py-0.5 rounded text-xs font-medium {{ $badgeClass }} flex-shrink-0">{{ $rel.type | title }}</span>
    </div>
    {{ end }}
    {{ end }}
  </div>
</section>
{{ end }}
{{ end }}

{{/* === LITIGATION === */}}
{{ with $person.litigation }}
{{ if gt (len .) 0 }}
<section class="bg-white rounded-xl border border-slate-200 p-5">
  <h3 class="text-sm font-bold text-navy mb-4 flex items-center gap-2" style="margin-top: 0;">
    <svg class="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
    </svg>
    Litigation
  </h3>
  <div class="space-y-3">
    {{ range $caseKey, $case := . }}
    {{ $caseData := index site.Data.litigation $caseKey }}
    {{ $caseHasPage := site.GetPage (printf "/litigation/%s" $caseKey) }}

    {{/* Determine status styling */}}
    {{ $statusClass := "bg-slate-100 text-slate-700" }}
    {{ if eq $case.status "active" }}
      {{ $statusClass = "bg-blue-100 text-blue-700" }}
    {{ else if eq $case.status "qualified-immunity-denied" }}
      {{ $statusClass = "bg-green-100 text-green-700" }}
    {{ else if eq $case.status "settled" }}
      {{ $statusClass = "bg-amber-100 text-amber-700" }}
    {{ else if eq $case.status "dismissed" }}
      {{ $statusClass = "bg-red-100 text-red-700" }}
    {{ end }}

    <div class="border border-slate-200 rounded-lg p-3">
      <div class="flex items-start justify-between gap-2 mb-2">
        {{ if $caseHasPage }}
        <a href="/litigation/{{ $caseKey }}/" class="font-medium text-navy hover:text-amber-600 transition-colors text-sm">
          {{ if $caseData }}{{ $caseData.title }}{{ else }}{{ $caseKey | humanize }}{{ end }}
        </a>
        {{ else }}
        <span class="font-medium text-navy text-sm">
          {{ if $caseData }}{{ $caseData.title }}{{ else }}{{ $caseKey | humanize }}{{ end }}
        </span>
        {{ end }}
        <span class="px-2 py-0.5 rounded text-xs font-medium {{ $statusClass }} whitespace-nowrap">
          {{ partial "format-text.html" $case.status }}
        </span>
      </div>

      {{ with $case.case_number }}
      <p class="text-xs text-slate-500 mb-2">Case No. {{ . }}</p>
      {{ end }}

      <div class="flex items-center gap-2 text-xs">
        <span class="px-2 py-0.5 rounded bg-slate-100 text-slate-600">{{ $case.role | title }}</span>
        {{ with $case.capacity }}
        <span class="text-slate-400">â€¢</span>
        <span class="text-slate-500">{{ . | title }} capacity</span>
        {{ end }}
      </div>

      {{ with $case.claims }}
      <div class="mt-2 pt-2 border-t border-slate-100">
        <p class="text-xs text-slate-500 mb-1">Claims:</p>
        <div class="flex flex-wrap gap-1">
          {{ range . }}
          <span class="px-1.5 py-0.5 rounded bg-slate-100 text-slate-600 text-xs">{{ . }}</span>
          {{ end }}
        </div>
      </div>
      {{ end }}
    </div>
    {{ end }}
  </div>
</section>
{{ end }}
{{ end }}

{{/* === CROSS-REFERENCES === */}}
{{ partial "cross-references.html" (dict "type" "person" "key" $personKey "page" $page) }}

{{/* === TAGS === */}}
{{ with $person.tags }}
<section class="bg-white rounded-xl border border-slate-200 p-5">
  <h3 class="text-sm font-bold text-navy mb-3 flex items-center gap-2" style="margin-top: 0;">
    <svg class="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
    </svg>
    Tags
  </h3>
  <div class="flex flex-wrap gap-2">
    {{ range . }}
    <span class="px-2.5 py-1 rounded-full bg-slate-100 text-slate-600 text-xs font-medium">{{ . }}</span>
    {{ end }}
  </div>
</section>
{{ end }}
