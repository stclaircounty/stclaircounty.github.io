{{/*
  Person Profile - Main Content (Left Column)

  Contains: Overview, Background, Incident Involvement, Elections, Depositions
*/}}

{{ $person := .person }}
{{ $personKey := .personKey }}
{{ $content := .content }}
{{ $page := .page }}
{{ $people := site.Data.people }}

{{/* === ALIASES === */}}
{{ with $person.aliases }}
<p class="text-sm text-slate-500 -mt-4 mb-6">Also known as: <span class="font-medium">{{ delimit . ", " }}</span></p>
{{ end }}

{{/* === OVERVIEW === */}}
{{ with $person.description }}
<section class="bg-white rounded-xl border border-slate-200 p-6">
  <h2 class="text-lg font-bold text-navy mb-4 flex items-center gap-2" style="margin-top: 0;">
    <div class="p-2 bg-slate-100 rounded-lg">
      <svg class="w-5 h-5 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
    </div>
    Overview
  </h2>
  <div class="prose prose-slate max-w-none">
    {{ . | markdownify }}
  </div>
</section>
{{ end }}

{{/* === BACKGROUND (Markdown content) === */}}
{{ with $content }}
<section class="bg-white rounded-xl border border-slate-200 p-6">
  <h2 class="text-lg font-bold text-navy mb-4 flex items-center gap-2" style="margin-top: 0;">
    <div class="p-2 bg-slate-100 rounded-lg">
      <svg class="w-5 h-5 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
      </svg>
    </div>
    Background
  </h2>
  <div class="prose prose-sm sm:prose-lg max-w-none">
    {{ . }}
  </div>
</section>
{{ end }}

{{/* === INCIDENT INVOLVEMENT === */}}
{{ with $person.involvement }}
{{ if gt (len .) 0 }}
<section class="bg-white rounded-xl border border-slate-200 p-6">
  <h2 class="text-lg font-bold text-navy mb-4 flex items-center gap-2" style="margin-top: 0;">
    <div class="p-2 bg-red-100 rounded-lg">
      <svg class="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
    </div>
    Incident Involvement
  </h2>
  <div class="space-y-4">
    {{ range $incidentKey, $inv := . }}
    {{ $incident := index site.Data.incidents $incidentKey }}
    {{ $incidentHasPage := site.GetPage (printf "/incidents/%s" $incidentKey) }}
    <div class="border border-slate-200 rounded-lg overflow-hidden">
      <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex items-center justify-between">
        <div>
          {{ if $incidentHasPage }}
          <a href="/incidents/{{ $incidentKey }}/" class="font-semibold text-navy hover:text-amber-600 transition-colors">
            {{ if $incident }}{{ $incident.title }}{{ else }}{{ $incidentKey | humanize }}{{ end }}
          </a>
          {{ else }}
          <span class="font-semibold text-navy">
            {{ if $incident }}{{ $incident.title }}{{ else }}{{ $incidentKey | humanize }}{{ end }}
          </span>
          {{ end }}
        </div>
        <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-slate-200 text-slate-700">{{ partial "format-text.html" $inv.role }}</span>
      </div>
      <div class="p-4">
        {{ with $inv.description }}
        <p class="text-slate-600 mb-3">{{ . }}</p>
        {{ end }}

        {{ with $inv.concerns }}
        <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-3">
          <h4 class="text-xs font-semibold text-red-700 uppercase tracking-wide mb-2 flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            Documented Concerns
          </h4>
          <ul class="space-y-1">
            {{ range . }}
            <li class="text-sm text-red-800 flex items-start gap-2">
              <span class="text-red-400 mt-0.5">•</span>
              {{ . }}
            </li>
            {{ end }}
          </ul>
        </div>
        {{ end }}

        {{ with $inv.details }}
        <div class="bg-slate-50 rounded-lg p-3">
          <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Details</h4>
          <ul class="space-y-1">
            {{ range . }}
            <li class="text-sm text-slate-600 flex items-start gap-2">
              <span class="text-slate-400 mt-0.5">•</span>
              {{ . }}
            </li>
            {{ end }}
          </ul>
        </div>
        {{ end }}
      </div>
    </div>
    {{ end }}
  </div>
</section>
{{ end }}
{{ end }}

{{/* === ELECTION HISTORY === */}}
{{ $elections := site.Data.elections }}
{{ $personElections := slice }}
{{ range $electionKey, $election := $elections }}
  {{ if not (hasPrefix $electionKey "_") }}
    {{ if index $election.candidates $personKey }}
      {{ $personElections = $personElections | append (merge $election (dict "key" $electionKey)) }}
    {{ end }}
  {{ end }}
{{ end }}
{{ if gt (len $personElections) 0 }}
<section class="bg-white rounded-xl border border-slate-200 p-6">
  <h2 class="text-lg font-bold text-navy mb-4 flex items-center gap-2" style="margin-top: 0;">
    <div class="p-2 bg-green-100 rounded-lg">
      <svg class="w-5 h-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
    Election History
  </h2>
  <div class="space-y-4">
    {{ range sort $personElections "date" "desc" }}
    {{ $election := . }}
    {{ $candidateInfo := index .candidates $personKey }}
    <div class="border border-slate-200 rounded-lg overflow-hidden">
      <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex items-start justify-between">
        <div>
          <p class="text-xs text-slate-500 mb-1">{{ .date | time.Format "January 2, 2006" }}</p>
          <h3 class="font-semibold text-navy">{{ .position }}</h3>
          <p class="text-sm text-slate-500">{{ .jurisdiction }} • {{ .type | title }}</p>
        </div>
        <div class="flex gap-2">
          {{ if eq $candidateInfo.result "won" }}
          <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Won</span>
          {{ else if eq $candidateInfo.result "lost" }}
          <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">Lost</span>
          {{ end }}
          {{ if $candidateInfo.incumbent }}
          <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Incumbent</span>
          {{ end }}
        </div>
      </div>
      <div class="p-4">
        <div class="flex flex-wrap gap-4 text-sm">
          {{ with $candidateInfo.party }}
          <div>
            <span class="text-slate-500">Party:</span>
            <span class="font-medium text-slate-700">{{ . }}</span>
          </div>
          {{ end }}
          {{ if and $candidateInfo.votes $candidateInfo.percentage }}
          <div>
            <span class="text-slate-500">Votes:</span>
            <span class="font-medium text-slate-700">{{ $candidateInfo.votes | lang.FormatNumber 0 }} ({{ $candidateInfo.percentage }}%)</span>
          </div>
          {{ end }}
        </div>

        {{/* Opponents */}}
        {{ $opponents := slice }}
        {{ range $candKey, $cand := .candidates }}
          {{ if ne $candKey $personKey }}
            {{ $oppPerson := index $people $candKey }}
            {{ $opponents = $opponents | append (merge $cand (dict "key" $candKey "name" (cond (ne $oppPerson nil) $oppPerson.name ($candKey | humanize)))) }}
          {{ end }}
        {{ end }}
        {{ if gt (len $opponents) 0 }}
        <div class="mt-4 pt-4 border-t border-slate-100">
          <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Opponents</p>
          <div class="space-y-2">
            {{ range $opponents }}
            <div class="flex items-center justify-between text-sm bg-slate-50 rounded-lg px-3 py-2">
              <div class="flex items-center gap-2">
                {{ $oppHasPage := site.GetPage (printf "/people/%s" .key) }}
                {{ if $oppHasPage }}
                <a href="/people/{{ .key }}/" class="font-medium text-navy hover:text-amber-600 transition-colors">{{ .name }}</a>
                {{ else }}
                <span class="font-medium text-navy">{{ .name }}</span>
                {{ end }}
                {{ with .party }}
                <span class="text-slate-400">({{ . }})</span>
                {{ end }}
              </div>
              <div class="text-slate-500">
                {{ if and .votes .percentage }}
                {{ .votes | lang.FormatNumber 0 }} ({{ .percentage }}%)
                {{ end }}
                {{ if eq .result "won" }}
                <span class="ml-2 px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Won</span>
                {{ end }}
              </div>
            </div>
            {{ end }}
          </div>
        </div>
        {{ end }}

        {{ with .notes }}
        <div class="mt-4 pt-4 border-t border-slate-100">
          <p class="text-sm text-slate-600">{{ . | markdownify }}</p>
        </div>
        {{ end }}
      </div>
    </div>
    {{ end }}
  </div>
</section>
{{ end }}

{{/* === DEPOSITIONS === */}}
{{ with $person.depositions }}
{{ if gt (len .) 0 }}
<section class="bg-white rounded-xl border border-slate-200 p-6">
  <h2 class="text-lg font-bold text-navy mb-4 flex items-center gap-2" style="margin-top: 0;">
    <div class="p-2 bg-amber-100 rounded-lg">
      <svg class="w-5 h-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
    </div>
    Depositions
  </h2>
  <div class="space-y-3">
    {{ range . }}
    {{ $depoKey := . }}
    {{ $depoData := index site.Data.depositions $depoKey }}
    {{ $depo := $depoData.deposition }}
    {{ $urlSlug := $depoKey | replaceRE "_" "-" }}
    {{ $depoHasPage := site.GetPage (printf "/depositions/%s" $urlSlug) }}
    <a href="/depositions/{{ $urlSlug }}/" class="flex items-center justify-between p-4 rounded-lg bg-amber-50 border border-amber-200 hover:border-amber-400 hover:shadow-md transition-all group">
      <div class="flex items-center gap-4">
        <div class="p-2 bg-amber-100 rounded-lg group-hover:bg-amber-200 transition-colors">
          <svg class="w-5 h-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
        </div>
        <div>
          <p class="font-semibold text-navy group-hover:text-amber-700 transition-colors">
            {{ if $depo }}{{ $depo.title }}{{ else }}{{ $depoKey | humanize }}{{ end }}
          </p>
          {{ if $depo }}
          <p class="text-sm text-slate-500">{{ $depo.date | time.Format "January 2, 2006" }}</p>
          {{ end }}
        </div>
      </div>
      <svg class="w-5 h-5 text-amber-500 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </a>
    {{ end }}
  </div>
</section>
{{ end }}
{{ end }}

{{/* === EDITORIAL NOTE === */}}
{{ with $person.note }}
<section class="bg-purple-50 border border-purple-200 rounded-xl p-6">
  <h2 class="text-lg font-bold text-purple-900 mb-3 flex items-center gap-2" style="margin-top: 0;">
    <div class="p-2 bg-purple-100 rounded-lg">
      <svg class="w-5 h-5 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
    Editorial Note
  </h2>
  <p class="text-purple-800">{{ . | markdownify }}</p>
</section>
{{ end }}
