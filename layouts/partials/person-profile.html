{{/*
  Person Profile Partial

  Displays all data sections for a person from people.yaml

  Parameters:
    - person: The person data from site.Data.people[key]
    - personKey: The key used to look up the person
    - content: The markdown content from the page (optional)
    - page: The Hugo page object (for linking related content)

  Section Order:
    1. Aliases
    2. Overview (description from YAML)
    3. Background (markdown content)
    4. Employment
    5. Credibility Assessment
    6. Elections
    7. Relationships
    8. Incident Involvement
    9. Depositions
    10. Editorial Note
    11. Tags
*/}}

{{ $person := .person }}
{{ $personKey := .personKey }}
{{ $content := .content }}
{{ $page := .page }}
{{ $people := site.Data.people }}
{{ $directory := site.Data.people_directory }}

{{/* Get section styling from directory config */}}
{{ $sectionStyle := dict "bg_color" "bg-gray-50" "icon_color" "text-gray-600" "badge_bg" "bg-gray-100" "badge_text" "text-gray-700" }}
{{ range $key, $section := $directory.sections }}
  {{ if in $section.people $personKey }}
    {{ $sectionStyle = $section }}
  {{ end }}
{{ end }}

<div class="space-y-8">

  {{/* === 1. ALIASES === */}}
  {{ with $person.aliases }}
  <p class="text-sm text-slate-light">Also known as: {{ delimit . ", " }}</p>
  {{ end }}

  {{/* === 2. OVERVIEW (Description from YAML) === */}}
  {{ with $person.description }}
  <section class="bg-white rounded-lg shadow-card p-6">
    <h2 class="text-lg font-bold text-navy mb-3 flex items-center gap-2" style="margin-top: 0;">
      {{ partial "header-icon.html" (dict "icon" "document" "class" "w-5 h-5 text-slate-light") }}
      Overview
    </h2>
    <div class="prose prose-sm max-w-none text-slate">
      {{ . | markdownify }}
    </div>
  </section>
  {{ end }}

  {{/* === 3. BACKGROUND (Markdown page content) === */}}
  {{ with $content }}
  <section class="bg-white rounded-lg shadow-card p-6">
    <h2 class="text-lg font-bold text-navy mb-3 flex items-center gap-2" style="margin-top: 0;">
      {{ partial "header-icon.html" (dict "icon" "document" "class" "w-5 h-5 text-slate-light") }}
      Background
    </h2>
    <div class="prose prose-sm sm:prose-lg max-w-none">
      {{ . }}
    </div>
  </section>
  {{ end }}

  {{/* === 4. EMPLOYMENT / PROFESSIONAL INFO === */}}
  {{ $hasEmployment := or $person.employer $person.department $person.division $person.title $person.firm $person.bar_state $person.court $person.start_date $person.end_date $person.side }}
  {{ if $hasEmployment }}
  <section class="bg-white rounded-lg shadow-card p-6">
    <h2 class="text-lg font-bold text-navy mb-4 flex items-center gap-2" style="margin-top: 0;">
      {{ partial "header-icon.html" (dict "icon" "building" "class" "w-5 h-5 text-slate-light") }}
      {{ if $person.firm }}Professional Details{{ else if $person.court }}Judicial Position{{ else }}Employment{{ end }}
    </h2>
    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
      {{ with $person.employer }}
      <div class="sm:col-span-2">
        <dt class="text-slate-light">Employer</dt>
        <dd class="font-medium text-navy">{{ . }}</dd>
      </div>
      {{ end }}
      {{ with $person.department }}
      <div>
        <dt class="text-slate-light">Department</dt>
        <dd class="font-medium text-navy">{{ . }}</dd>
      </div>
      {{ end }}
      {{ with $person.division }}
      <div>
        <dt class="text-slate-light">Division</dt>
        <dd class="font-medium text-navy">{{ . }}</dd>
      </div>
      {{ end }}
      {{ with $person.title }}
      <div>
        <dt class="text-slate-light">Title</dt>
        <dd class="font-medium text-navy">{{ . }}</dd>
      </div>
      {{ end }}
      {{ with $person.firm }}
      <div class="sm:col-span-2">
        <dt class="text-slate-light">Firm</dt>
        <dd class="font-medium text-navy">{{ . }}</dd>
      </div>
      {{ end }}
      {{ with $person.bar_state }}
      <div>
        <dt class="text-slate-light">Bar Admission</dt>
        <dd class="font-medium text-navy">{{ . }}</dd>
      </div>
      {{ end }}
      {{ with $person.court }}
      <div class="sm:col-span-2">
        <dt class="text-slate-light">Court</dt>
        <dd class="font-medium text-navy">{{ . }}</dd>
      </div>
      {{ end }}
      {{ with $person.start_date }}
      <div>
        <dt class="text-slate-light">Start Date</dt>
        <dd class="font-medium text-navy">{{ time.Format "January 2006" . }}</dd>
      </div>
      {{ end }}
      {{ with $person.end_date }}
      <div>
        <dt class="text-slate-light">End Date</dt>
        <dd class="font-medium text-navy">{{ time.Format "January 2006" . }}</dd>
      </div>
      {{ end }}
      {{ with $person.side }}
      <div>
        <dt class="text-slate-light">Litigation Side</dt>
        <dd class="font-medium text-navy">{{ . | title }}</dd>
      </div>
      {{ end }}
    </dl>
  </section>
  {{ end }}

  {{/* === 5. CREDIBILITY ASSESSMENT === */}}
  {{/* Only show credibility section if there are documented factors or confirmed "compromised" status */}}
  {{ if or $person.credibility_factors (eq $person.credibility "compromised") }}
  <section class="bg-white rounded-lg shadow-card p-6">
    <h2 class="text-lg font-bold text-navy mb-3 flex items-center gap-2" style="margin-top: 0;">
      {{ partial "header-icon.html" (dict "icon" "warning" "class" "w-5 h-5 text-red-500") }}
      Credibility Assessment
    </h2>

    {{ if eq $person.credibility "compromised" }}
    <div class="alert alert-danger mb-4">
      <div class="flex items-start gap-2">
        {{ partial "header-icon.html" (dict "icon" "warning" "class" "w-4 h-4 text-red-600 mt-0.5 flex-shrink-0") }}
        <div>
          <p class="font-semibold text-red-800">Credibility Compromised</p>
          {{ with $person.credibility_note }}
          <p class="text-sm text-red-700">{{ . }}</p>
          {{ end }}
        </div>
      </div>
    </div>
    {{ else if eq $person.credibility "not-applicable" }}
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4">
      <p class="text-sm text-slate">
        <span class="font-medium">Status:</span> {{ $person.credibility_note | default "Not applicable" }}
      </p>
    </div>
    {{ end }}

    {{ with $person.credibility_factors }}
    <div class="bg-gray-50 rounded-lg p-4">
      <h3 class="text-sm font-semibold text-slate uppercase tracking-wide mb-3">Factors</h3>
      <dl class="space-y-2 text-sm">
        {{ range $key, $value := . }}
        <div class="flex justify-between">
          <dt class="text-slate-light">{{ $key | humanize }}</dt>
          <dd class="font-medium {{ if or (eq $value "Compromised") (eq $value "Severely Compromised") }}text-red-600{{ else }}text-navy{{ end }}">{{ $value }}</dd>
        </div>
        {{ end }}
      </dl>
    </div>
    {{ end }}
  </section>
  {{ end }}

  {{/* === 6. ELECTION HISTORY === */}}
  {{ $elections := site.Data.elections }}
  {{ $personElections := slice }}
  {{ range $electionKey, $election := $elections }}
    {{ if not (hasPrefix $electionKey "_") }}
      {{ if index $election.candidates $personKey }}
        {{ $personElections = $personElections | append (merge $election (dict "key" $electionKey)) }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ if gt (len $personElections) 0 }}
  <section class="bg-white rounded-lg shadow-card p-6">
    <h2 class="text-lg font-bold text-navy mb-4 flex items-center gap-2" style="margin-top: 0;">
      {{ partial "header-icon.html" (dict "icon" "check-circle" "class" "w-5 h-5 text-slate-light") }}
      Election History
    </h2>
    <div class="space-y-4">
      {{ range sort $personElections "date" "desc" }}
      {{ $election := . }}
      {{ $candidateInfo := index .candidates $personKey }}
      <div class="border border-gray-200 rounded-lg p-4">
        <div class="flex items-start justify-between mb-2">
          <div>
            <p class="text-sm text-slate-light">{{ .date | time.Format "January 2, 2006" }}</p>
            <h3 class="font-semibold text-navy">{{ .position }} - {{ .type | title }}</h3>
            <p class="text-sm text-slate-light">{{ .jurisdiction }}</p>
          </div>
          <div class="text-right">
            {{ if eq $candidateInfo.result "won" }}
            <span class="badge bg-green-100 text-green-800">Won</span>
            {{ else if eq $candidateInfo.result "lost" }}
            <span class="badge bg-red-100 text-red-800">Lost</span>
            {{ end }}
            {{ if $candidateInfo.incumbent }}
            <span class="badge bg-blue-100 text-blue-800">Incumbent</span>
            {{ end }}
          </div>
        </div>

        {{/* Candidate details */}}
        {{ with $candidateInfo.party }}
        <p class="text-sm text-slate">Party: <span class="font-medium">{{ . }}</span></p>
        {{ end }}
        {{ if and $candidateInfo.votes $candidateInfo.percentage }}
        <p class="text-sm text-slate">
          Votes: <span class="font-medium">{{ $candidateInfo.votes | lang.FormatNumber 0 }}</span>
          ({{ $candidateInfo.percentage }}%)
        </p>
        {{ end }}

        {{/* Opponents */}}
        {{ $opponents := slice }}
        {{ range $candKey, $cand := .candidates }}
          {{ if ne $candKey $personKey }}
            {{ $oppPerson := index $people $candKey }}
            {{ $opponents = $opponents | append (merge $cand (dict "key" $candKey "name" (cond (ne $oppPerson nil) $oppPerson.name ($candKey | humanize)))) }}
          {{ end }}
        {{ end }}
        {{ if gt (len $opponents) 0 }}
        <div class="mt-3 pt-3 border-t border-gray-100">
          <p class="text-xs font-semibold text-slate uppercase tracking-wide mb-2">Opponents</p>
          <div class="space-y-1">
            {{ range $opponents }}
            <div class="flex items-center justify-between text-sm">
              <div class="flex items-center gap-2">
                {{ $oppHasPage := site.GetPage (printf "/people/%s" .key) }}
                {{ if $oppHasPage }}
                <a href="/people/{{ .key }}/" class="text-navy hover:text-accent">{{ .name }}</a>
                {{ else }}
                <span class="text-navy">{{ .name }}</span>
                {{ end }}
                {{ with .party }}
                <span class="text-slate-light">({{ . }})</span>
                {{ end }}
              </div>
              <div class="text-slate-light">
                {{ if and .votes .percentage }}
                {{ .votes | lang.FormatNumber 0 }} ({{ .percentage }}%)
                {{ end }}
                {{ if eq .result "won" }}
                <span class="badge bg-green-100 text-green-800 ml-2">Won</span>
                {{ end }}
              </div>
            </div>
            {{ end }}
          </div>
        </div>
        {{ end }}

        {{/* Notes */}}
        {{ with .notes }}
        <div class="mt-3 pt-3 border-t border-gray-100">
          <p class="text-sm text-slate">{{ . | markdownify }}</p>
        </div>
        {{ end }}
      </div>
      {{ end }}
    </div>
  </section>
  {{ end }}

  {{/* === 7. RELATIONSHIPS === */}}
  {{ with $person.relationships }}
  {{ if gt (len .) 0 }}
  <section class="bg-white rounded-lg shadow-card p-6">
    <h2 class="text-lg font-bold text-navy mb-3 flex items-center gap-2" style="margin-top: 0;">
      {{ partial "header-icon.html" (dict "icon" "link" "class" "w-5 h-5 text-slate-light") }}
      Relationships
    </h2>
    <div class="space-y-3">
      {{ range $relKey, $rel := . }}
      {{ $relPerson := index $people $relKey }}
      {{ $relHasPage := site.GetPage (printf "/people/%s" $relKey) }}
      <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50 border border-gray-200">
        <div class="flex-1">
          {{ if $relHasPage }}
          <a href="/people/{{ $relKey }}/" class="font-semibold text-navy hover:text-accent">
            {{ if $relPerson }}{{ $relPerson.name }}{{ else }}{{ $relKey }}{{ end }}
          </a>
          {{ else }}
          <span class="font-semibold text-navy">
            {{ if $relPerson }}{{ $relPerson.name }}{{ else }}{{ $relKey }}{{ end }}
          </span>
          {{ end }}
          <p class="text-sm text-slate-light">{{ $rel.detail }}</p>
        </div>
        <span class="badge {{ if eq $rel.type "family" }}bg-red-100 text-red-800{{ else }}bg-yellow-100 text-yellow-800{{ end }}">
          {{ $rel.type | title }}
        </span>
      </div>
      {{ end }}
    </div>
  </section>
  {{ end }}
  {{ end }}

  {{/* === 8. INCIDENT INVOLVEMENT === */}}
  {{ with $person.involvement }}
  {{ if gt (len .) 0 }}
  <section class="bg-white rounded-lg shadow-card p-6">
    <h2 class="text-lg font-bold text-navy mb-3 flex items-center gap-2" style="margin-top: 0;">
      {{ partial "header-icon.html" (dict "icon" "warning" "class" "w-5 h-5 text-slate-light") }}
      Incident Involvement
    </h2>
    <div class="space-y-4">
      {{ range $incidentKey, $inv := . }}
      {{ $incident := index site.Data.incidents $incidentKey }}
      {{ $incidentHasPage := site.GetPage (printf "/incidents/%s" $incidentKey) }}
      <div class="border border-gray-200 rounded-lg p-4">
        <div class="flex items-start justify-between mb-2">
          <div>
            {{ if $incidentHasPage }}
            <a href="/incidents/{{ $incidentKey }}/" class="font-semibold text-navy hover:text-accent">
              {{ if $incident }}{{ $incident.title }}{{ else }}{{ $incidentKey | humanize }}{{ end }}
            </a>
            {{ else }}
            <span class="font-semibold text-navy">
              {{ if $incident }}{{ $incident.title }}{{ else }}{{ $incidentKey | humanize }}{{ end }}
            </span>
            {{ end }}
          </div>
          <span class="badge bg-slate-100 text-slate-700">{{ $inv.role | title }}</span>
        </div>
        {{ with $inv.description }}
        <p class="text-sm text-slate mb-2">{{ . }}</p>
        {{ end }}
        {{ with $inv.concerns }}
        <div class="mt-3 pt-3 border-t border-gray-100">
          <h4 class="text-xs font-semibold text-red-600 uppercase tracking-wide mb-2">Documented Concerns</h4>
          <ul class="text-sm text-slate space-y-1">
            {{ range . }}
            <li class="flex items-start gap-2">
              <span class="text-red-500 mt-1">•</span>
              {{ . }}
            </li>
            {{ end }}
          </ul>
        </div>
        {{ end }}
        {{ with $inv.details }}
        <div class="mt-3 pt-3 border-t border-gray-100">
          <h4 class="text-xs font-semibold text-slate uppercase tracking-wide mb-2">Details</h4>
          <ul class="text-sm text-slate space-y-1">
            {{ range . }}
            <li class="flex items-start gap-2">
              <span class="text-slate-light mt-1">•</span>
              {{ . }}
            </li>
            {{ end }}
          </ul>
        </div>
        {{ end }}
      </div>
      {{ end }}
    </div>
  </section>
  {{ end }}
  {{ end }}

  {{/* === 9. DEPOSITIONS === */}}
  {{ with $person.depositions }}
  {{ if gt (len .) 0 }}
  <section class="bg-white rounded-lg shadow-card p-6">
    <h2 class="text-lg font-bold text-navy mb-3 flex items-center gap-2" style="margin-top: 0;">
      {{ partial "header-icon.html" (dict "icon" "document" "class" "w-5 h-5 text-slate-light") }}
      Depositions
    </h2>
    <div class="space-y-3">
      {{ range . }}
      {{ $depoKey := . }}
      {{ $depo := index site.Data.depositions $depoKey }}
      {{ $depoHasPage := site.GetPage (printf "/depositions/%s" $depoKey) }}
      <div class="flex items-center justify-between p-3 rounded-lg bg-gray-50 border border-gray-200">
        <div>
          {{ if $depoHasPage }}
          <a href="/depositions/{{ $depoKey }}/" class="font-semibold text-navy hover:text-accent">
            {{ if $depo }}{{ $depo.title }}{{ else }}{{ $depoKey | humanize }}{{ end }}
          </a>
          {{ else }}
          <span class="font-semibold text-navy">
            {{ if $depo }}{{ $depo.title }}{{ else }}{{ $depoKey | humanize }}{{ end }}
          </span>
          {{ end }}
          {{ if $depo }}
          <p class="text-sm text-slate-light">{{ $depo.date | time.Format "January 2, 2006" }}</p>
          {{ end }}
        </div>
        {{ if and $depo $depo.pdf_file }}
        <span class="badge bg-gold/20 text-gold">PDF Available</span>
        {{ end }}
      </div>
      {{ end }}
    </div>
  </section>
  {{ end }}
  {{ end }}

  {{/* === 10. EDITORIAL NOTE (for judges, etc.) === */}}
  {{ with $person.note }}
  <section class="bg-purple-50 border border-purple-200 rounded-lg p-6">
    <h2 class="text-lg font-bold text-purple-900 mb-2 flex items-center gap-2" style="margin-top: 0;">
      {{ partial "header-icon.html" (dict "icon" "building" "class" "w-5 h-5 text-purple-600") }}
      Editorial Note
    </h2>
    <p class="text-sm text-purple-800">{{ . | markdownify }}</p>
  </section>
  {{ end }}

  {{/* === 11. TAGS === */}}
  {{ with $person.tags }}
  <section class="bg-white rounded-lg shadow-card p-6">
    <h2 class="text-lg font-bold text-navy mb-3 flex items-center gap-2" style="margin-top: 0;">
      {{ partial "header-icon.html" (dict "icon" "tag" "class" "w-5 h-5 text-slate-light") }}
      Tags
    </h2>
    <div class="flex flex-wrap gap-2">
      {{ range . }}
      <span class="badge bg-gray-100 text-gray-700">{{ . }}</span>
      {{ end }}
    </div>
  </section>
  {{ end }}

</div>
